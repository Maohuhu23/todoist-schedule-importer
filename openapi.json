{
  "openapi": "3.1.0",
  "info": {
    "title": "Todoist Schedule Importer v3",
    "version": "3.0.0",
    "description": "批量将结构化课表/时间块导入 Todoist 的服务，支持 section 分组、duration 时长、中文时间解析等功能。"
  },
  "servers": [
    {
      "url": "https://你的服务.onrender.com"
    }
  ],
  "paths": {
    "/import_schedule_to_todoist": {
      "post": {
        "operationId": "importScheduleToTodoist",
        "summary": "批量导入课表到 Todoist",
        "description": "接收一组课程/时间块描述，把它们转换成 Todoist 任务（自动创建项目和标签），支持 create / replace_project / dry_run 等选项。",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/ImportRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "导入结果，包含成功创建的任务及错误信息。",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ImportResponse"
                }
              }
            }
          }
        }
      }
    },
    "/query_tasks": {
      "post": {
        "operationId": "queryTodoistTasks",
        "summary": "查询 Todoist 任务列表",
        "description": "按项目、标签、时间范围筛选任务，用于回答'今天有什么课'、'下周五的安排'等问题。",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/TasksQuery"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "返回符合条件的任务列表",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/TasksQueryResponse"
                }
              }
            }
          }
        }
      }
    },
    "/free_slots": {
      "post": {
        "operationId": "computeFreeSlots",
        "summary": "计算空档时间",
        "description": "基于现有任务计算指定时间范围内的空闲时间段，用于智能安排学习块。",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/FreeSlotRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "返回空闲时间段列表",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/FreeSlotResponse"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "ScheduleItem": {
        "type": "object",
        "description": "一条课 / 时间块，对应一个 Todoist 任务。",
        "properties": {
          "title": {
            "type": "string",
            "description": "任务标题或课程名，例如 'A2-1 Further Math'"
          },
          "description": {
            "type": "string",
            "description": "备注，例如教室、老师、上课方式等"
          },
          "project_name": {
            "type": "string",
            "description": "Todoist 项目名，不存在时会自动创建"
          },
          "labels": {
            "type": "array",
            "description": "标签名列表，不存在的会自动创建",
            "items": {
              "type": "string"
            }
          },
          "priority": {
            "type": "integer",
            "minimum": 1,
            "maximum": 4,
            "default": 1,
            "description": "Todoist 优先级（1~4，4 为最高）"
          },
          "due_string": {
            "type": "string",
            "description": "Todoist 自然语言时间，例如 'every Monday at 9:00'"
          },
          "start_datetime": {
            "type": "string",
            "format": "date-time",
            "description": "开始时间，ISO 8601 格式，例如 '2025-11-18T09:00:00+08:00'"
          },
          "end_datetime": {
            "type": "string",
            "format": "date-time",
            "description": "结束时间，会写进 description 方便查看"
          },
          "timezone": {
            "type": "string",
            "description": "IANA 时区字符串，例如 'Asia/Singapore'"
          },
          "section_name": {
            "type": "string",
            "description": "Todoist 项目中的 section 名称，例如 'Monday'、'IELTS'，不存在时会自动创建"
          },
          "duration_minutes": {
            "type": "integer",
            "minimum": 1,
            "description": "任务持续时长（分钟），会映射到 Todoist 的 duration 字段"
          },
          "due_lang": {
            "type": "string",
            "description": "自然语言时间的语言代码，例如 'zh'（中文）、'en'（英文），提升 due_string 解析成功率"
          }
        },
        "required": ["title"]
      },
      "ImportOptions": {
        "type": "object",
        "description": "控制本次导入行为的全局选项。",
        "properties": {
          "mode": {
            "type": "string",
            "enum": ["create", "replace_project"],
            "default": "create",
            "description": "导入模式：create=只追加任务；replace_project=清空某项目后再创建"
          },
          "replace_project_name": {
            "type": "string",
            "description": "当 mode=replace_project 时，要被清空并重建的项目名"
          },
          "dry_run": {
            "type": "boolean",
            "default": false,
            "description": "为 true 时不真正调用 Todoist，只返回会创建哪些任务（task_id 为 'dry-run'）"
          },
          "default_project_name": {
            "type": "string",
            "description": "items 未指定 project_name 时的默认项目名"
          },
          "default_labels": {
            "type": "array",
            "description": "items 未指定 labels 时的默认标签列表",
            "items": {
              "type": "string"
            }
          },
          "default_priority": {
            "type": "integer",
            "minimum": 1,
            "maximum": 4,
            "default": 1,
            "description": "items 未设置 priority 时的默认优先级（1~4）"
          },
          "default_timezone": {
            "type": "string",
            "default": "Asia/Singapore",
            "description": "items 未设置 timezone 时的默认时区"
          },
          "title_prefix": {
            "type": "string",
            "description": "给所有任务标题统一加的前缀，例如 '[课表] '"
          },
          "title_suffix": {
            "type": "string",
            "description": "给所有任务标题统一加的后缀"
          },
          "default_section_name": {
            "type": "string",
            "description": "items 未指定 section_name 时的默认 section 名称"
          },
          "layout_hint": {
            "type": "string",
            "description": "布局提示（纯内部约定，用于指导 GPT 风格），例如：'by_weekday' / 'by_subject'"
          }
        }
      },
      "ImportRequest": {
        "type": "object",
        "properties": {
          "items": {
            "type": "array",
            "minItems": 1,
            "items": {
              "$ref": "#/components/schemas/ScheduleItem"
            }
          },
          "options": {
            "$ref": "#/components/schemas/ImportOptions"
          }
        },
        "required": ["items"]
      },
      "CreatedTask": {
        "type": "object",
        "properties": {
          "index": {
            "type": "integer",
            "description": "对应原始 items 数组里的下标"
          },
          "task_id": {
            "type": "string",
            "description": "创建出的 Todoist 任务 ID；dry_run 模式下为 'dry-run'"
          },
          "content": {
            "type": "string",
            "description": "任务标题"
          },
          "project_id": {
            "type": "string",
            "nullable": true,
            "description": "任务所在项目 ID"
          },
          "dry_run": {
            "type": "boolean",
            "description": "是否为 dry_run 模拟结果"
          }
        },
        "required": ["index", "task_id", "content"]
      },
      "ErrorInfo": {
        "type": "object",
        "properties": {
          "index": {
            "type": "integer",
            "description": "出错的那条 items 下标"
          },
          "message": {
            "type": "string",
            "description": "错误信息（用于调试）"
          }
        },
        "required": ["index", "message"]
      },
      "ImportResponse": {
        "type": "object",
        "properties": {
          "created": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/CreatedTask"
            }
          },
          "errors": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/ErrorInfo"
            }
          }
        }
      },
      "TasksQuery": {
        "type": "object",
        "description": "查询任务的筛选条件",
        "properties": {
          "project_names": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "要查询的项目名列表，例如 ['Schedule']；为空则查所有项目"
          },
          "label_filters": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "必须同时包含的标签名列表，例如 ['FMath', 'school']"
          },
          "date_from": {
            "type": "string",
            "format": "date-time",
            "description": "筛选 due 在这个时间之后的任务（含）"
          },
          "date_to": {
            "type": "string",
            "format": "date-time",
            "description": "筛选 due 在这个时间之前的任务（含）"
          },
          "include_without_due": {
            "type": "boolean",
            "default": true,
            "description": "是否包含没有 due 的任务"
          },
          "include_completed": {
            "type": "boolean",
            "default": false,
            "description": "是否包含已完成任务（当前实现仅支持未完成）"
          },
          "timezone": {
            "type": "string",
            "default": "Asia/Singapore",
            "description": "用于把日期筛选统一到同一时区"
          },
          "limit": {
            "type": "integer",
            "minimum": 1,
            "maximum": 1000,
            "default": 200,
            "description": "最多返回多少条任务，防止一次返回过多数据"
          }
        }
      },
      "TaskSummary": {
        "type": "object",
        "description": "任务摘要信息",
        "properties": {
          "id": {
            "type": "string"
          },
          "content": {
            "type": "string"
          },
          "description": {
            "type": "string",
            "nullable": true
          },
          "project_id": {
            "type": "string",
            "nullable": true
          },
          "project_name": {
            "type": "string",
            "nullable": true
          },
          "section_id": {
            "type": "string",
            "nullable": true
          },
          "section_name": {
            "type": "string",
            "nullable": true
          },
          "labels": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "priority": {
            "type": "integer",
            "minimum": 1,
            "maximum": 4,
            "default": 1
          },
          "due_datetime": {
            "type": "string",
            "format": "date-time",
            "nullable": true,
            "description": "有具体时间的 due"
          },
          "due_date": {
            "type": "string",
            "format": "date",
            "nullable": true,
            "description": "只有日期的 due"
          },
          "raw_due_string": {
            "type": "string",
            "nullable": true,
            "description": "Todoist 的 due.string，例如 'every Monday at 09:05'"
          },
          "duration_minutes": {
            "type": "integer",
            "nullable": true,
            "description": "任务持续时长（分钟）"
          },
          "is_completed": {
            "type": "boolean",
            "default": false
          }
        },
        "required": ["id", "content"]
      },
      "TasksQueryResponse": {
        "type": "object",
        "properties": {
          "tasks": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/TaskSummary"
            }
          }
        }
      },
      "FreeSlotRequest": {
        "type": "object",
        "description": "计算空档时间的请求",
        "properties": {
          "project_names": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "主要用来找日程的项目，例如 ['Schedule', 'Study Blocks']"
          },
          "label_filters": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "把哪些标签视为'占用时间'的任务，例如 ['school', 'ielts']"
          },
          "date_from": {
            "type": "string",
            "format": "date-time",
            "description": "空档搜索起点"
          },
          "date_to": {
            "type": "string",
            "format": "date-time",
            "description": "空档搜索终点"
          },
          "timezone": {
            "type": "string",
            "default": "Asia/Singapore",
            "description": "定义 date_from / date_to 所在时区"
          },
          "workday_start": {
            "type": "string",
            "default": "08:00",
            "description": "每天视作可用时间的开始，例如 '08:00'"
          },
          "workday_end": {
            "type": "string",
            "default": "23:00",
            "description": "每天视作可用时间的结束，例如 '23:00'"
          },
          "min_slot_minutes": {
            "type": "integer",
            "default": 45,
            "description": "认为是'有效空档'的最短时长"
          }
        },
        "required": ["date_from", "date_to"]
      },
      "FreeSlot": {
        "type": "object",
        "description": "一个空档时间段",
        "properties": {
          "start": {
            "type": "string",
            "format": "date-time"
          },
          "end": {
            "type": "string",
            "format": "date-time"
          }
        }
      },
      "FreeSlotResponse": {
        "type": "object",
        "properties": {
          "free_slots": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/FreeSlot"
            }
          }
        }
      }
    }
  }
}
